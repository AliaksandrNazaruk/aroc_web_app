<!DOCTYPE html>
<html lang="en" style="overflow: hidden; height: 105%;">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    html, body {
      height: 100%;
      width: 100%;
    }
    body {
      font-family: sans-serif;
      background-color: #ffffff;
      transform-origin: top left;
      transform: scale(1);
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      overflow: hidden;
    }
    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #ffffff;
      padding-left: 2vw;
      width: 100%;
      height: 100%;
      min-height: 0;
      z-index: 1000;
      box-sizing: border-box;
      position: static;
    }
    .status-left {
      display: flex;
      align-items: center;
      height: 100%;
    }
    .status-right {
      display: flex;
      align-items: center;
      height: 100%;
    }
    .settings-button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      margin-right: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 70%;
      aspect-ratio: 1/1;
      border-radius: 50%;
      transition: background 0.2s;
    }
    .settings-button:hover {
      background: #f0f1f3;
    }
    .settings-button svg {
      width: 1.2em;
      height: 1.2em;
      fill: #000000;
      transition: transform 0.3s ease;
      display: block;
    }
    .settings-button:hover svg {
      transform: rotate(30deg);
    }
    .status-item {
      height: 70%;
      display: flex;
      align-items: center;
      margin-left: 2vw;
      color: #000000;
      font-size: 1em;
      transform: scale(1);
    }
    .status-item:first-child {
      margin-left: 0;
    }
    .status-item svg, .status-item img, .device-icon {
      height: 100%;
      max-height: 1.5em;
      width: auto;
      max-width: 2em;
      object-fit: contain;
      display: block;
      vertical-align: middle;
    }
    .device-icon.error {
      opacity: 0.5;
    }
    .battery-percentage {
      margin-left: 0.5em;
      font-size: 0.9em;
    }
    .battery-fill {
      fill: green; 
      transition: height 0.3s ease, y 0.3s ease, fill 0.3s ease;
    }
    .charging-icon {
      display: none;
    }
  </style>
</head>
<body>
  <div class="status-bar">
    <div class="status-left">
      <button class="settings-button" id="settings-button">
        <svg viewBox="0 0 24 24">
          <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12 3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97 0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1 0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66z"/>
        </svg>
      </button>
    </div>
    <div class="status-right">
      <div class="status-item">
        <img id="car-icon" class="device-icon" src="./icons/car.svg" alt="Car Status">
      </div>
      <div class="status-item">
        <img id="lift-icon" class="device-icon" src="./icons/lift.svg" alt="Lift Status">
      </div>
      <div class="status-item">
        <img id="manipulator-icon" class="device-icon" src="./icons/manipulator.svg" alt="Manipulator Status">
      </div>
      <div class="status-item wifi-icon">
        <img src="./icons/wifi_on.svg" alt="Wi-Fi Icon">
      </div>
      <div class="status-item battery">
        <svg viewBox="0 0 24 24" fill="none">
          <rect x="9" y="2" width="6" height="2" fill="black"></rect>
          <rect x="7" y="4" width="10" height="18" rx="2" ry="2" stroke="black" stroke-width="1" fill="none"></rect>
          <rect class="battery-fill" x="7" y="22" width="10" height="0"></rect>
        </svg>
        <div class="battery-percentage">--%</div>
      </div>
      <div class="status-item charge">
        <div class="charging-icon" style="width: 24px;display: flex;margin-left: -1vw;padding-right: 2vw;">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M13 3v7h7l-9 11v-7H4l9-11z"></path>
          </svg>
        </div>
      </div>
    </div>
  </div>
  <script>
    document.getElementById('settings-button').addEventListener('click', function() {
      window.open('keyboard-config.html', 'Keyboard Config', 'width=800,height=600');
    });
    async function updateStatusBar() {
      try {
        const [carData, igusData, xarmData] = await Promise.all([
          fetch("/api/symovo_car/data").then(res => res.json()),
          fetch("/api/igus/data").then(res => res.json()),
          fetch("/api/xarm/data").then(res => res.json())
        ]);
        const batteryText = document.querySelector(".battery-percentage");
        const batteryFillRect = document.querySelector(".battery-fill");
        const chargingIcon = document.querySelector(".charging-icon");
        if (typeof carData.battery_level === "number") {
          const levelPercent = carData.battery_level * 100;
          batteryText.textContent = levelPercent.toFixed(0) + "%";
          const totalHeight = 18;
          const fillHeight = totalHeight * carData.battery_level;
          const fillY = 22 - fillHeight;
          batteryFillRect.setAttribute("y", fillY.toFixed(1));
          batteryFillRect.setAttribute("height", fillHeight.toFixed(1));
          if (levelPercent < 20) {
            batteryFillRect.setAttribute("fill", "red");
          } else if (levelPercent < 50) {
            batteryFillRect.setAttribute("fill", "orange");
          } else {
            batteryFillRect.setAttribute("fill", "green");
          }
        } else {
          batteryText.textContent = "--%";
          batteryFillRect.setAttribute("height", "0");
          batteryFillRect.setAttribute("y", "22");
        }

        // ========= Молния (признак зарядки) =========
        // Если reed_closed = true => показываем
        if (carData.state_flags && carData.state_flags.reed_closed === true) {
          chargingIcon.style.display = "flex";
        } else {
          chargingIcon.style.display = "none";
        }

        const carIcon = document.getElementById("car-icon");
        const liftIcon = document.getElementById("lift-icon");
        const manipulatorIcon = document.getElementById("manipulator-icon");
        if (carData.error) {
          carIcon.src = "./icons/car_error.svg";
          carIcon.classList.add("error");
        } else {
          carIcon.src = "./icons/car.svg";
          carIcon.classList.remove("error");
        }
        if (igusData.error || !igusData.homing) {
          liftIcon.src = "./icons/lift_error.svg";
          liftIcon.classList.add("error");
        } else {
          liftIcon.src = "./icons/lift.svg";
          liftIcon.classList.remove("error");
        }
        if (xarmData.has_error || xarmData.has_err_warn) {
          manipulatorIcon.src = "./icons/manipulator_error.svg";
          manipulatorIcon.classList.add("error");
        } else {
          manipulatorIcon.src = "./icons/manipulator.svg";
          manipulatorIcon.classList.remove("error");
        }
      } catch (error) {
        console.error("Ошибка при обновлении статуса:", error);
      }
    }
    setInterval(updateStatusBar, 2500);
    window.addEventListener("load", updateStatusBar);
  </script>
</body>
</html>
